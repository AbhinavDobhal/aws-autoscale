# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user  nginx;
worker_processes  8;

error_log  /var/log/nginx/error.log;
#error_log  /var/log/nginx/error.log  notice;
#error_log  /var/log/nginx/error.log  info;

pid        /var/run/nginx.pid;


events {
    #worker_connections  1024;
    worker_connections  30000;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    server_tokens off;
    
    resolver 172.31.0.2;
    #resolver_timeout 10s;

    log_format  main  '$upstream_addr - $remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

#TO INCREASE THE UPLOAD SIZE
#
client_max_body_size 2M;
    #gzip  on;
    
    proxy_buffer_size   32k;
    #proxy_buffer_size   128k;
    proxy_buffers   4 32k;
   # proxy_buffers   4 256k;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

  upstream checkout {
#IPHERE;
#	server 172.31.13.147 weight=4;	

    }





    server {
        listen       8080;
if ($http_user_agent ~* (Netsparker) ) {
   return 502;
}
location ~* (home-try-on-program|hometryon|me/index|storelocator|2cod2|uploadprescmob|outofstocksubscription) {
	proxy_pass  http://172.31.3.228;
	proxy_set_header X-Forwarded-Proto "SSL";
	proxy_set_header Host $http_host;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
##### undefined redirection ####
location ~* (/eyeglasses/popular-searches/undefined) {
                return http://www.lenskart.com/eyeglasses/popular-searches/first-pair-free.html;
        }

location ~* (/sunglasses/collections/undefined) {
                return http://www.lenskart.com/sunglasses/collections/aviators-wayfarers.html;
        }



location ~* (/eyeglasses/shop-by/gender-age/undefined) {
                return http://www.lenskart.com/eyeglasses/shop-by/gender-age/men-18-40-yrs.html;
        }

location ~* (undefined) {
                return http://www.lenskart.com;
        }
##################################################################

######### To redirect Kodak-lens 



location ~ (Kodak-Lens) {
                return http://www.lenskart.com/kodak-lens;
        }
		
location ~* (Eye-CheckUp) {
                return http://www.lenskart.com/home-try-on-program.html;
        }

##################################################################



location ~* (win.ini|response.write|<script>|/etc/passwd|sleep|acunetix) {
		return 403;
        }

        location ~* (checkout|multistepcheckout|ajax/index|ccavenuepay|rewardpoints|payucheckout|icici|emi|TestSsl|SFAResponse|citrus|storecredit|codcheck|seamless|payu|voicetree|valyooapi|review/product/post|payback|wallet|mswipe|account) {
#            proxy_pass  http://172.31.1.144;
            proxy_pass  http://checkout;
#            proxy_pass  http://CheckoutLB-1404583351.ap-southeast-1.elb.amazonaws.com$request_uri;
            proxy_read_timeout 300;
            proxy_pass_request_headers on;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }            
        
        location / {
            #proxy_pass   http://ValyooLB-990731056.ap-southeast-1.elb.amazonaws.com$request_uri;
            proxy_pass   http://internal-Internal-LB-webserver-502468278.ap-southeast-1.elb.amazonaws.com$request_uri;
#            proxy_pass  http://172.31.1.59;
            proxy_pass_request_headers on;
            proxy_read_timeout 300;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }


    }
}

http{
upstream checkout {
#IPHERE;
#	server 172.31.13.147 weight=4;
}

#To INCREASE THE UPLOAD SIZE
client_max_body_size 2M;
server {
        listen 443;
        ssl on;
        ssl_certificate /etc/pki/tls/certs/nginx_cert.crt;
        ssl_certificate_key /etc/pki/tls/certs/www_lenskart_com_nginx.pem;

      ssl_session_timeout 5m;

#       ssl_protocols SSLv3 TLSv1;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;       
       ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
       ssl_prefer_server_ciphers on;

#location ~* (saveShipping|onepage|saveOrder|otp|cart|isAjax|updatecoupon|gettotal) {

#proxy_pass  http://172.31.11.49;

#  proxy_set_header X-Forwarded-Proto "SSL";
              proxy_set_header Host $http_host;
 #             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  #      }

      location / {
              proxy_pass http://checkout;
              proxy_set_header X-Forwarded-Proto "SSL";
	      proxy_set_header Host $http_host;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
}
}

